<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>T432 Photos</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
    <style>
    .flex-container{
      display: flex;
      flex-flow: row nowrap;
      justify-content: space-around;
      width: 100%;
      align-items: center;

    }

    #main_container, #content{
      width: 100%;
    }

    body {
      width: 100%;
      background-color: #F7F6EF;
      margin: 0;

    }

    #label_year, p {
      font-size: min(1.2rem, 2vw);
    }

    #img2{
      width: 100%;
      height: auto;
      transition: 0.4s;
    }

    #img1{
      width: 100%;
      height: auto;
      transition: 0.4s;

    }

    #img1:hover {
      transform: scale(1.2);
    }

    .div1 {
      transition: 0.4s;
    }
    .div2 {
      transition: 0.4s;
      margin: 0 0 0 15px;

    }
    .div1:hover {
      transform: scale(1.2);
    }
    .div2:hover {
      transform: scale(1.2);
    }

  </style>

  <body id="main_body">
    <div id="main_container">
    <form id='Form'>
      <center><h2>Troop Photos</h2></center>
      <center>
        <br>
        <label id="label_year" for='_year'>Pick a year: </label>
        <select id='_year' name='_year' onchange="fetch_more(this)">
          <option value='2024'>2024</option>
          <option value='2023' selected>2023</option>
          <option value='2022'>2022</option>
          <option value='2021'>2021</option>
          <option value='2020'>2020</option>
          <option value='2019'>2019</option>
          <option value='2018'>2018</option>
          <option value='2017'>2017</option>
          <option value='2016'>2016</option>
          <option value='2015'>2015</option>
          <option value='2014'>2014</option>
          <option value='2013'>2013</option>
          <option value='2012'>2012</option>
          </select>
          </center>
          <br>
     </form>
     <br>
     <div id='content'>
     </div>
    </div>

  </body>

  <script>
    var CLIENT_ID = '535857122296-upqmglmmp6fuiakh5m3bs5i7sft33n7v.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyB7WuDhnX-e-vYQ76PeyNbX9AfNDIAb2xA';
    var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

    var announce_page = false;

    var dynamic_html_string = "";
    var i = 0;
    var sheet_id = "";

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("Form").style.display = "none";
    }, false);

    function handleClientLoad() {
      gapi.load('client', initClient);
    }

    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        init_web_app(document.getElementById("_year").value);
      }, function(error) {
        console.log(JSON.stringify(error, null, 2));
      });
    }

    function init_web_app(init_select){
      var queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      //var init_select = document.getElementById("_year").value;
      if (urlParams.get("scope")) {
        urlParams.get("scope") == "announce" ? (
          init_select = "Announce",
          announce_page = true,
          document.getElementById("main_body").style.backgroundColor = "#FFEBCD"
      ) : null;
      }

      if (urlParams.get("id")) {
        urlParams.get("id") != null ? sheet_id = urlParams.get("id") : null;
      }

      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheet_id,
        range: init_select + "!A1:D",
      }).then(function(response) {
        var range = response.result;
        //console.log(range.values);
        //wreath_data = range2.values;
        build_html(range.values);
        //announce_page == false ? fetch_logic(range.values) : build_announcement_page(range.values);

      }, function(response) {
        console.log('Error: ' + response.result.error.message);
        invalid_input();
      });

    }

    function fetch_more(element){
      var value = element.value;
      init_web_app(value);
    }

    function fetch_logic(dynamic_data1){
      document.getElementById("content").innerHTML = "<center style='color:blue'>" + "Loading..." + "</center";
      //google.script.run.withSuccessHandler(build_html).withFailureHandler(invalid_input).get_data_from_sheets(value);
      build_html(dynamic_data1);
    }

    //the build_html function is called only-if the Google Sheet part is a success
    function build_html(dynamic_data){
      announce_page == false ? document.getElementById("Form").style.display = "" : null;
      var dynamic_html_string = "";
      var i = 0;
      var url_split = [];


      //Iterate against the number of rows in the spreadsheet (dynamic_data.length)
      while (i < dynamic_data.length){

        //starting on the 2nd row
        i++;

        //check to see if column A has a yes. Keep going to the next column until you find one.
        while (i < dynamic_data.length) {
          if (dynamic_data[i][0] != "yes" || !dynamic_data[i][1] || !dynamic_data[i][3]) {i++;}
            else break;
        }
        if (i < dynamic_data.length){
          url_split = dynamic_data[i][3].split(/=w/);
          dynamic_html_string += "<div class='flex-container'>";
          dynamic_html_string += "<div class='div1'>";

          dynamic_html_string += "<p>" + dynamic_data[i][1];
          if (dynamic_data[i][2].length > 0){
            dynamic_html_string = dynamic_html_string + " (<a href='" + dynamic_data[i][2] + "' target='_blank'>link to album</a>)";
          }

          dynamic_html_string = dynamic_html_string +  "<br><a href='" + dynamic_data[i][2] + "' target='_blank'>" + "<img id='img2' src='" +
            url_split[0] + "=w500-no?authuser=0 alt=' ' /></a></p>";
        }
          dynamic_html_string += "</div>";
          dynamic_html_string += "<div class='div2'>";

        i++;

        //check to see if column A has a yes. Keep going to the next column until you find one.
        while (i < dynamic_data.length) {
          if (dynamic_data[i][0] != "yes" || !dynamic_data[i][1] || !dynamic_data[i][3]) {i++;}
            else break;
        }

        if (i < dynamic_data.length){
          url_split = dynamic_data[i][3].split(/=w/);
          dynamic_html_string = dynamic_html_string + "<p>" + dynamic_data[i][1];
          if (dynamic_data[i][2].length > 0){

            dynamic_html_string = dynamic_html_string + " (<a href='" + dynamic_data[i][2] + "' target='_blank'>link to album</a>)";
          }

          dynamic_html_string = dynamic_html_string +  "<br><a href='" + dynamic_data[i][2] + "' target='_blank'>" + "<img id='img2' src='" +
            url_split[0] + "=w500-no?authuser=0 alt=' ' /></a></p>" + "</div> </div>";
        }

      }

      //append the dynamic_html_string to the html body section
     // document.body.innerHTML += "<center>" + dynamic_html_string + "</center>";
     document.getElementById("content").innerHTML = "<center>" + dynamic_html_string + "</center>";
    }

    function invalid_input(){
      document.getElementById("content").innerHTML = "<center>" + "The year you picked doesn't have any data<br>" + "</center>";
    }
  </script>

  <script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>

</html>
